<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista de lista para roles de permisos -->
    <record id="view_permission_role_tree" model="ir.ui.view">
        <field name="name">permission.role.list</field>
        <field name="model">permission.role</field>
        <field name="type">list</field>
        <field name="arch" type="xml">
            <list string="Roles de Permisos">
                <field name="name"/>
                <field name="active" widget="boolean_toggle"/>
                <field name="module_ids" widget="many2many_tags"/>
            </list>
        </field>
    </record>

    <!-- Vista de formulario para roles de permisos -->
    <record id="view_permission_role_form" model="ir.ui.view">
        <field name="name">permission.role.form</field>
        <field name="model">permission.role</field>
        <field name="arch" type="xml">
            <form string="Rol de Permisos">
                <sheet>
                    <group>
                        <group>
                            <field name="name"/>
                            <field name="active"/>
                        </group>
                    </group>
                    <group>
                        <field name="description" placeholder="Descripci√≥n del rol y qu√© permisos incluye..."/>
                    </group>
                    <notebook>
                        <page string="Grupos de Permisos">
                            <group>
                                <group string="Grupos a Agregar">
                                    <field name="group_ids" widget="many2many_tags" options="{'color_field': 'color'}"/>
                                </group>
                                <group string="Grupos a Remover">
                                    <field name="excluded_group_ids" widget="many2many_tags" options="{'color_field': 'color'}"/>
                                </group>
                            </group>
                        </page>
                        <page string="M√≥dulos Afectados">
                            <field name="module_ids" widget="many2many_tags"/>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Vista de b√∫squeda para roles -->
    <record id="view_permission_role_search" model="ir.ui.view">
        <field name="name">permission.role.search</field>
        <field name="model">permission.role</field>
        <field name="arch" type="xml">
            <search string="Buscar Roles">
                <field name="name"/>
                <field name="module_ids"/>
                <filter string="Activos" name="active" domain="[('active', '=', True)]"/>
            </search>
        </field>
    </record>

    <!-- Vista de formulario para el gestor de permisos (wizard) -->
    <record id="view_permission_manager_form" model="ir.ui.view">
        <field name="name">permission.manager.form</field>
        <field name="model">permission.manager</field>
        <field name="arch" type="xml">
            <form string="Gestor de Permisos">
                <sheet>
                    <group>
                        <group>
                            <field name="user_id" options="{'no_create': True}"/>
                            <field name="copy_from_user_id" 
                                   options="{'no_create': True}"
                                   placeholder="Seleccione un usuario para copiar sus permisos"/>
                            <field name="role_ids" 
                                   widget="many2many_tags"
                                   options="{'no_create': True}"
                                   domain="[('active', '=', True)]"
                                   placeholder="Seleccione uno o m√°s roles predefinidos"/>
                            <field name="role_apply_mode" 
                                   widget="radio"
                                   options="{'horizontal': true}"
                                   invisible="not role_ids"/>
                            <div class="alert alert-info" role="alert" invisible="not role_ids">
                                <p><strong>‚ÑπÔ∏è Modo de Aplicaci√≥n:</strong></p>
                                <p><strong>Agregar al Existente:</strong> Mantiene los permisos actuales del usuario y agrega los permisos de los roles seleccionados.</p>
                                <p><strong>Reemplazar Todo:</strong> Elimina todos los permisos actuales (excepto los esenciales) y aplica solo los permisos de los roles seleccionados.</p>
                            </div>
                        </group>
                        <group>
                            <button name="action_copy_permissions" 
                                    type="object" 
                                    string="Copiar Permisos" 
                                    class="btn-secondary"
                                    invisible="not copy_from_user_id or not user_id"
                                    help="Copiar todos los permisos del usuario seleccionado a este usuario"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Permisos Actuales del Usuario" invisible="not user_id">
                            <group>
                                <group string="M√≥dulos con Acceso">
                                    <field name="current_user_modules" 
                                           widget="many2many_tags" 
                                           nolabel="1"
                                           readonly="1"
                                           placeholder="Seleccione un usuario para ver sus m√≥dulos actuales..."/>
                                </group>
                                <group string="Grupos de Permisos">
                                    <field name="current_user_groups" 
                                           widget="many2many_tags" 
                                           nolabel="1"
                                           readonly="1"
                                           placeholder="Seleccione un usuario para ver sus grupos actuales..."/>
                                </group>
                            </group>
                            <div class="alert alert-info" role="alert">
                                <p><strong>‚ÑπÔ∏è Informaci√≥n Actual:</strong> Esta secci√≥n muestra los permisos y grupos que el usuario tiene actualmente antes de aplicar cambios.</p>
                            </div>
                        </page>
                    </notebook>
                    <group>
                        <field name="apply_restriction" 
                               string="Aplicar Restricci√≥n de M√≥dulos"
                               help="Si est√° activado, se aplicar√° la restricci√≥n seg√∫n el modo seleccionado"/>
                    </group>
                    <group invisible="not apply_restriction">
                        <field name="restriction_mode" 
                               widget="radio" 
                               options="{'horizontal': true}"
                               help="Seleccione el modo de restricci√≥n: Permitir solo seleccionados o Bloquear solo seleccionados"/>
                        <field name="operation_mode" 
                               widget="radio" 
                               options="{'horizontal': true}"
                               invisible="restriction_mode != 'allow_list'"
                               help="Agregar: Agrega permisos sin quitar los existentes. Reemplazar: Solo deja los m√≥dulos seleccionados y quita todos los dem√°s."/>
                    </group>
                    <notebook>
                        <page string="M√≥dulos Permitidos" invisible="not apply_restriction or restriction_mode != 'allow_list'">
                            <group>
                                <field name="allowed_modules" 
                                       widget="many2many_tags" 
                                       nolabel="1"
                                       domain="[('state', '=', 'installed')]"
                                       placeholder="Seleccione los m√≥dulos a los que el usuario tendr√° acceso."/>
                            </group>
                            <div class="alert alert-info" role="alert" invisible="operation_mode == 'add'">
                                <p><strong>‚ÑπÔ∏è Modo: Lista de Permitidos - REEMPLAZAR</strong></p>
                                <p>Solo los m√≥dulos seleccionados aqu√≠ tendr√°n acceso. Todos los dem√°s m√≥dulos instalados ser√°n bloqueados autom√°ticamente al guardar.</p>
                            </div>
                            <div class="alert alert-success" role="alert" invisible="operation_mode == 'replace'">
                                <p><strong>‚úÖ Modo: Lista de Permitidos - AGREGAR</strong></p>
                                <p>Los m√≥dulos seleccionados se agregar√°n a los permisos existentes del usuario. Los permisos actuales NO se quitar√°n.</p>
                                <p><strong>√ötil cuando:</strong> Quieres dar acceso a m√≥dulos adicionales sin afectar los permisos que el usuario ya tiene.</p>
                            </div>
                        </page>
                        <page string="M√≥dulos a Bloquear" invisible="not apply_restriction or restriction_mode != 'block_list'">
                            <group>
                                <field name="blocked_modules" 
                                       widget="many2many_tags" 
                                       nolabel="1"
                                       domain="[('state', '=', 'installed')]"
                                       placeholder="Busque y seleccione los m√≥dulos que desea bloquear espec√≠ficamente. Solo estos m√≥dulos ser√°n bloqueados."/>
                            </group>
                            <div class="alert alert-warning" role="alert">
                                <p><strong>üö´ Modo: Lista de Bloqueados</strong></p>
                                <p>Solo los m√≥dulos seleccionados aqu√≠ ser√°n bloqueados. Todos los dem√°s m√≥dulos instalados mantendr√°n su acceso actual.</p>
                                <p><strong>√ötil cuando:</strong> Solo quieres bloquear m√≥dulos espec√≠ficos (ej: Compras, Ventas) sin afectar el resto.</p>
                            </div>
                        </page>
                        <page string="Vista Previa de Grupos" invisible="not apply_restriction">
                            <group>
                                <field name="preview_groups" 
                                       widget="many2many_tags" 
                                       nolabel="1"
                                       readonly="1"
                                       placeholder="Seleccione m√≥dulos permitidos para ver los grupos que se agregar√°n..."/>
                            </group>
                            <div class="alert alert-warning" role="alert">
                                <p><strong>‚ö†Ô∏è Vista Previa:</strong> Estos son los grupos que se agregar√°n autom√°ticamente basados en los m√≥dulos permitidos. Puede excluir grupos espec√≠ficos en la pesta√±a "Control Fino de Grupos".</p>
                            </div>
                        </page>
                        <page string="Control Fino de Grupos">
                            <group>
                                <field name="groups_to_exclude" 
                                       widget="many2many_tags" 
                                       nolabel="1"
                                       placeholder="Seleccione grupos espec√≠ficos que desea remover, incluso si pertenecen a m√≥dulos permitidos. √ötil para dejar solo lo esencial."/>
                            </group>
                            <div class="alert alert-warning" role="alert">
                                <p><strong>üîß Control Fino:</strong> Los grupos seleccionados aqu√≠ se remover√°n del usuario, incluso si pertenecen a m√≥dulos permitidos. √ötil para dejar solo permisos esenciales (ej: quitar permisos de "Manager" y dejar solo "Usuario").</p>
                                <p><strong>Ejemplo:</strong> Si permite "Inventario", puede quitar "Gestor de Inventario" y dejar solo "Usuario de Inventario" para acceso b√°sico.</p>
                            </div>
                        </page>
                        <page string="M√≥dulos Instalados (Referencia)">
                            <field name="module_ids" widget="many2many_tags" nolabel="1" readonly="1"/>
                            <div class="alert alert-info" role="alert">
                                <p><strong>‚ÑπÔ∏è Nota:</strong> Esta es solo una lista de referencia de todos los m√≥dulos instalados. Para restringir acceso, active la opci√≥n "Restringir Acceso a M√≥dulos Espec√≠ficos" y seleccione los m√≥dulos permitidos en la pesta√±a anterior.</p>
                            </div>
                        </page>
                    </notebook>
                </sheet>
                <footer>
                    <button name="action_debug_user_groups" 
                            type="object" 
                            string="üîç Debug Grupos" 
                            class="btn-secondary"
                            invisible="not user_id"
                            help="Validar grupos del usuario y detectar conflictos de tipo de usuario"/>
                    <button name="action_diagnose_user_duplicates" 
                            type="object" 
                            string="üîç Diagnosticar Duplicados" 
                            class="btn-secondary"
                            invisible="not user_id"
                            help="Diagnosticar si el usuario tiene duplicados o relaciones compartidas que puedan causar que los permisos se repliquen a otros usuarios"/>
                    <button name="action_view_current_groups" 
                            type="object" 
                            string="Ver Grupos Actuales" 
                            class="btn-secondary"
                            help="Ver los grupos de permisos que tiene actualmente el usuario"/>
                    <button name="action_apply_permissions" 
                            type="object" 
                            string="Aplicar Permisos" 
                            class="btn-primary"/>
                    <button string="Cancelar" special="cancel" class="btn-secondary"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Acci√≥n para abrir el gestor de permisos (vista original que funcionaba) -->
    <record id="action_permission_manager" model="ir.actions.act_window">
        <field name="name">Gestor de Permisos</field>
        <field name="res_model">permission.manager</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="view_id" ref="view_permission_manager_form"/>
    </record>
    
    <!-- Acci√≥n alternativa para vista avanzada -->
    <record id="action_permission_manager_advanced" model="ir.actions.act_window">
        <field name="name">Gestor de Permisos (Avanzado)</field>
        <field name="res_model">permission.manager</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="view_id" ref="view_permission_manager_form"/>
    </record>

    <!-- Acci√≥n para ver roles de permisos -->
    <record id="action_permission_role" model="ir.actions.act_window">
        <field name="name">Roles de Permisos</field>
        <field name="res_model">permission.role</field>
        <field name="view_mode">list,form</field>
        <field name="view_id" ref="view_permission_role_tree"/>
        <field name="search_view_id" ref="view_permission_role_search"/>
    </record>

    <!-- Vista mejorada de usuarios mostrando permisos -->
    <!-- Comentado temporalmente - se puede activar despu√©s de instalar el m√≥dulo -->
    <!--
    <record id="view_users_form_inherit_permissions" model="ir.ui.view">
        <field name="name">res.users.form.inherit.permissions</field>
        <field name="model">res.users</field>
        <field name="inherit_id" ref="base.view_users_form"/>
        <field name="arch" type="xml">
            <xpath expr="//sheet" position="before">
                <header>
                    <button name="action_open_permission_manager" 
                            type="object" 
                            string="Gestor de Permisos" 
                            class="btn-secondary"
                            icon="fa-shield"/>
                </header>
            </xpath>
        </field>
    </record>
    -->

</odoo>
