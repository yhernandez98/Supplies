<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Heredar vista de stock.lot para mostrar referencia interna como Many2one -->
        <record id="view_stock_lot_form_inherit_internal_ref" model="ir.ui.view">
            <field name="name">stock.lot.form.inherit.internal.ref</field>
            <field name="model">stock.lot</field>
            <field name="inherit_id" ref="stock.view_production_lot_form"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='ref']" position="replace">
                    <field name="internal_ref_id" 
                           options="{'no_open': True}"
                           context="{'default_product_id': product_id, 'search_default_product_id': product_id}"
                           placeholder="Seleccione o cree una referencia interna"/>
                </xpath>
            </field>
        </record>

        <!-- Vista de búsqueda para lotes con campos incompletos (sin group_by: evita Invalid view en Odoo 19) -->
        <record id="view_stock_lot_incomplete_fields_search" model="ir.ui.view">
            <field name="name">stock.lot.incomplete.fields.search</field>
            <field name="model">stock.lot</field>
            <field name="type">search</field>
            <field name="arch" type="xml">
                <search string="Buscar Productos Pendientes">
                    <field name="display_contact_id" string="Contacto" 
                           filter_domain="['|', ('display_contact_id.name', 'ilike', self), ('display_contact_id.display_name', 'ilike', self)]"/>
                    <field name="name" string="Número de Serie"/>
                    <field name="inventory_plate" string="Placa de Inventario"/>
                    <field name="product_id" string="Producto"/>
                </search>
            </field>
        </record>

        <!-- Vista de lista para lotes con campos incompletos -->
        <record id="view_stock_lot_incomplete_fields_list" model="ir.ui.view">
            <field name="name">stock.lot.incomplete.fields.list</field>
            <field name="model">stock.lot</field>
            <field name="arch" type="xml">
                <list string="Productos Pendientes de Información" 
                      default_order="display_contact_id,product_asset_category_id,product_asset_class_id,name"
                      editable="top"
                      default_group_by="display_contact_id"
                      create="0">
                    <field name="name" string="Número de Serie" readonly="1"/>
                    <field name="inventory_plate" string="Placa de Inventario"/>
                    <field name="security_plate" string="Placa de Seguridad"/>
                    <field name="internal_ref_id" string="Referencia Interna" 
                           options="{'no_open': True, 'no_create': False, 'no_create_edit': False}"
                           context="{'default_product_id': product_id, 'search_default_product_id': product_id}"/>
                    <field name="product_id" readonly="1"/>
                    <field name="product_asset_category_id" string="Categoría de Activo" readonly="1"/>
                    <field name="product_asset_class_id" string="Clase de Activo" readonly="1"/>
                    <field name="display_location_id" string="Ubicación" readonly="1"/>
                    <field name="display_contact_id" string="Contacto" readonly="1"/>
                </list>
            </field>
        </record>

        <!-- Acción para ver lotes con campos incompletos -->
        <record id="action_stock_lot_incomplete_fields" model="ir.actions.act_window">
            <field name="name">Productos Pendientes de Información</field>
            <field name="res_model">stock.lot</field>
            <field name="view_mode">list,form</field>
            <field name="view_id" ref="view_stock_lot_incomplete_fields_list"/>
            <field name="search_view_id" ref="view_stock_lot_incomplete_fields_search"/>
            <field name="domain">['&amp;', '|', '|', ('inventory_plate', '=', False), ('security_plate', '=', False), ('ref', '=', False), '|', ('product_id.classification', '=', False), ('product_id.classification', '!=', 'component')]</field>
            <field name="context">{'group_by': ['display_contact_id', 'product_asset_category_id', 'product_asset_class_id']}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No hay productos pendientes de información
                </p>
                <p>
                    Esta vista muestra todos los productos (lotes/series) de todas las ubicaciones que tienen al menos uno de estos campos vacíos:
                    <ul>
                        <li><strong>Placa de Inventario</strong></li>
                        <li><strong>Placa de Seguridad</strong></li>
                        <li><strong>Referencia Interna</strong></li>
                    </ul>
                    Puedes editar cada lote para completar la información faltante. Los lotes se muestran con colores de advertencia para facilitar su identificación.
                </p>
            </field>
        </record>
    </data>
</odoo>
