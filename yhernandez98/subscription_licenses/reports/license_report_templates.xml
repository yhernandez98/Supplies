<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Template: Reporte por Cliente -->
    <template id="report_license_by_partner_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="wizard">
                <t t-set="assignments" t-value="wizard.assignments_ids"/>
                <t t-set="month_name" t-value="dict(wizard._fields['month'].selection).get(wizard.month, '') if wizard.month else ''"/>
                <t t-call="web.external_layout">
                    <div class="page">
                        <div class="oe_structure"/>
                        <div class="row">
                            <div class="col-12">
                                <h2>Reporte de Licencias por Cliente</h2>
                                <p t-if="month_name and wizard.year">Período: <strong><t t-esc="month_name"/> <t t-esc="wizard.year"/></strong></p>
                                <p t-if="not month_name">Criterio: <strong>Todas las asignaciones</strong></p>
                            </div>
                        </div>
                        <t t-set="current_partner" t-value="None"/>
                        <t t-foreach="assignments" t-as="assignment">
                            <t t-set="partner_name" t-value="assignment.partner_id.name or 'Sin Cliente'"/>
                            <t t-if="partner_name != current_partner">
                                <t t-if="current_partner is not None">
                                    <t t-raw="'&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&lt;/div&gt;'"/>
                                </t>
                                <t t-set="current_partner" t-value="partner_name"/>
                                <t t-raw="'&lt;div class=&quot;row mt-4&quot;&gt;&lt;div class=&quot;col-12&quot;&gt;&lt;h3&gt;'"/>
                                <t t-esc="partner_name"/>
                                <t t-raw="'&lt;/h3&gt;&lt;table class=&quot;table table-sm table-bordered&quot;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Licencia&lt;/th&gt;&lt;th&gt;Cantidad&lt;/th&gt;&lt;th&gt;Equipos&lt;/th&gt;&lt;th&gt;Usuarios&lt;/th&gt;&lt;th&gt;Total USD&lt;/th&gt;&lt;th&gt;Total COP&lt;/th&gt;&lt;th&gt;Estado&lt;/th&gt;&lt;th&gt;Fecha Fin&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;'"/>
                            </t>
                            <tr>
                                <td><t t-esc="assignment.license_display_name or assignment.license_id.name or ''"/></td>
                                <td class="text-right"><t t-esc="assignment.quantity"/></td>
                                <td class="text-right"><t t-esc="assignment.equipment_count"/></td>
                                <td class="text-right"><t t-esc="assignment.user_count"/></td>
                                <td class="text-right">$<t t-esc="'{:,.2f}'.format(assignment.total_cost_usd)"/></td>
                                <td class="text-right">$<t t-esc="'{:,.2f}'.format(assignment.total_cost_cop)"/></td>
                                <td><t t-esc="dict(assignment._fields['state'].selection).get(assignment.state, '')"/></td>
                                <td><t t-esc="assignment.end_date.strftime('%d/%m/%Y') if assignment.end_date else ''"/></td>
                            </tr>
                            <tr t-if="wizard.include_equipment or wizard.include_users">
                                <td colspan="8" class="pl-5">
                                    <t t-if="wizard.include_equipment"/>Equipos: <t t-foreach="assignment.equipment_ids.filtered(lambda e: e.lot_id)" t-as="equipment"><t t-esc="equipment.lot_id.name or ''"/><t t-if="not equipment_last">, </t></t>
                                    <t t-if="wizard.include_users"/> Usuarios: <t t-foreach="assignment.equipment_ids.filtered(lambda e: e.contact_id).mapped('contact_id')" t-as="contact"><t t-esc="contact.name or ''"/><t t-if="not contact_last">, </t></t>
                                </td>
                            </tr>
                        </t>
                        <t t-raw="'&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&lt;/div&gt;'"/>
                        <div class="row mt-4"><div class="col-12">
                            <h4>Resumen Total</h4>
                            <p><strong>Total USD:</strong> $<t t-esc="'{:,.2f}'.format(sum(assignments.mapped('total_cost_usd')))"/></p>
                            <p><strong>Total COP:</strong> $<t t-esc="'{:,.2f}'.format(sum(assignments.mapped('total_cost_cop')))"/></p>
                        </div></div>
                    </div>
                </t>
            </t>
        </t>
    </template>

    <!-- Template: Reporte por Tipo de Licencia -->
    <template id="report_license_by_type_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="wizard">
                <t t-set="assignments" t-value="wizard.assignments_ids"/>
                <t t-set="month_name" t-value="dict(wizard._fields['month'].selection).get(wizard.month, '') if wizard.month else ''"/>
                <t t-call="web.external_layout">
                    <div class="page">
                        <div class="oe_structure"/>
                        <div class="row">
                            <div class="col-12">
                                <h2>Reporte de Licencias por Tipo</h2>
                                <p t-if="month_name and wizard.year">Período: <strong><t t-esc="month_name"/> <t t-esc="wizard.year"/></strong></p>
                                <p t-if="not month_name">Criterio: <strong>Todas las asignaciones</strong></p>
                            </div>
                        </div>
                        <t t-set="current_license" t-value="None"/>
                        <t t-foreach="assignments" t-as="assignment">
                            <t t-set="license_name" t-value="assignment.license_display_name or assignment.license_id.name or 'Sin Licencia'"/>
                            <t t-if="license_name != current_license">
                                <t t-if="current_license is not None">
                                    <t t-raw="'&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&lt;/div&gt;'"/>
                                </t>
                                <t t-set="current_license" t-value="license_name"/>
                                <t t-raw="'&lt;div class=&quot;row mt-4&quot;&gt;&lt;div class=&quot;col-12&quot;&gt;&lt;h3&gt;'"/>
                                <t t-esc="license_name"/>
                                <t t-raw="'&lt;/h3&gt;&lt;table class=&quot;table table-sm table-bordered&quot;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Cliente&lt;/th&gt;&lt;th&gt;Cantidad&lt;/th&gt;&lt;th&gt;Equipos&lt;/th&gt;&lt;th&gt;Usuarios&lt;/th&gt;&lt;th&gt;Total USD&lt;/th&gt;&lt;th&gt;Total COP&lt;/th&gt;&lt;th&gt;Estado&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;'"/>
                            </t>
                            <tr>
                                <td><t t-esc="assignment.partner_id.name or ''"/></td>
                                <td class="text-right"><t t-esc="assignment.quantity"/></td>
                                <td class="text-right"><t t-esc="assignment.equipment_count"/></td>
                                <td class="text-right"><t t-esc="assignment.user_count"/></td>
                                <td class="text-right">$<t t-esc="'{:,.2f}'.format(assignment.total_cost_usd)"/></td>
                                <td class="text-right">$<t t-esc="'{:,.2f}'.format(assignment.total_cost_cop)"/></td>
                                <td><t t-esc="dict(assignment._fields['state'].selection).get(assignment.state, '')"/></td>
                            </tr>
                        </t>
                        <t t-raw="'&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&lt;/div&gt;'"/>
                        <div class="row mt-4"><div class="col-12">
                            <h4>Resumen Total</h4>
                            <p><strong>Total USD:</strong> $<t t-esc="'{:,.2f}'.format(sum(assignments.mapped('total_cost_usd')))"/></p>
                            <p><strong>Total COP:</strong> $<t t-esc="'{:,.2f}'.format(sum(assignments.mapped('total_cost_cop')))"/></p>
                        </div></div>
                    </div>
                </t>
            </t>
        </t>
    </template>

    <!-- Template: Reporte de Costos -->
    <template id="report_license_costs_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="wizard">
                <t t-set="assignments" t-value="wizard.assignments_ids"/>
                <t t-set="month_name" t-value="dict(wizard._fields['month'].selection).get(wizard.month, '') if wizard.month else ''"/>
                <t t-call="web.external_layout">
                    <div class="page">
                        <div class="oe_structure"/>
                        <div class="row">
                            <div class="col-12">
                                <h2>Reporte de Costos de Licencias</h2>
                                <p>Período: <strong><t t-esc="month_name"/> <t t-esc="wizard.year"/></strong></p>
                            </div>
                        </div>
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Licencia</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unit. USD</th>
                                    <th>TRM</th>
                                    <th>Total USD</th>
                                    <th>Total COP</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="assignments" t-as="assignment">
                                    <tr>
                                        <td><t t-esc="assignment.partner_id.name or ''"/></td>
                                        <td><t t-esc="assignment.license_display_name or assignment.license_id.name or ''"/></td>
                                        <td class="text-right"><t t-esc="assignment.quantity"/></td>
                                        <td class="text-right">$<t t-esc="'{:,.2f}'.format((assignment.total_cost_usd / assignment.quantity) if assignment.quantity else 0)"/></td>
                                        <td class="text-right"><t t-esc="'{:,.2f}'.format(assignment.trm_rate or 0)"/></td>
                                        <td class="text-right">$<t t-esc="'{:,.2f}'.format(assignment.total_cost_usd)"/></td>
                                        <td class="text-right">$<t t-esc="'{:,.2f}'.format(assignment.total_cost_cop)"/></td>
                                    </tr>
                                </t>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="5" class="text-right"><strong>Total:</strong></td>
                                    <td class="text-right"><strong>$<t t-esc="'{:,.2f}'.format(sum(assignments.mapped('total_cost_usd')))"/></strong></td>
                                    <td class="text-right"><strong>$<t t-esc="'{:,.2f}'.format(sum(assignments.mapped('total_cost_cop')))"/></strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </t>
            </t>
        </t>
    </template>

    <!-- Template: Reporte de Vencidas -->
    <template id="report_license_expiring_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="wizard">
                <t t-set="assignments" t-value="wizard.assignments_ids"/>
                <t t-call="web.external_layout">
                    <div class="page">
                        <div class="oe_structure"/>
                        <div class="row">
                            <div class="col-12">
                                <h2>Reporte de Licencias Vencidas y Próximas a Vencer</h2>
                                <p>Fecha de generación: <strong><t t-esc="context_today().strftime('%d/%m/%Y')"/></strong></p>
                            </div>
                        </div>
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Licencia</th>
                                    <th>Cantidad</th>
                                    <th>Equipos</th>
                                    <th>Usuarios</th>
                                    <th>Fecha Fin</th>
                                    <th>Días Restantes</th>
                                    <th>Total COP</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="assignments" t-as="assignment">
                                    <t t-set="days_left" t-value="(assignment.end_date - context_today()).days if assignment.end_date else 0"/>
                                    <tr t-attf-class="#{days_left &lt; 0 and 'text-danger' or (days_left &lt;= 30 and 'text-warning' or '')}">
                                        <td><t t-esc="assignment.partner_id.name or ''"/></td>
                                        <td><t t-esc="assignment.license_display_name or assignment.license_id.name or ''"/></td>
                                        <td class="text-right"><t t-esc="assignment.quantity"/></td>
                                        <td class="text-right"><t t-esc="assignment.equipment_count"/></td>
                                        <td class="text-right"><t t-esc="assignment.user_count"/></td>
                                        <td><t t-esc="assignment.end_date.strftime('%d/%m/%Y') if assignment.end_date else ''"/></td>
                                        <td class="text-right">
                                            <t t-if="days_left &lt; 0">Vencida (<t t-esc="abs(days_left)"/> días)</t>
                                            <t t-else=""><t t-esc="days_left"/> días</t>
                                        </td>
                                        <td class="text-right">$<t t-esc="'{:,.2f}'.format(assignment.total_cost_cop)"/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </t>
            </t>
        </t>
    </template>
</odoo>
