<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <record id="view_internal_reference_form" model="ir.ui.view">
            <field name="name">internal.reference.form</field>
            <field name="model">internal.reference</field>
            <field name="arch" type="xml">
                <form string="Referencia Interna">
                    <sheet>
                        <group>
                            <field name="product_id" 
                                   required="1" 
                                   options="{'no_open': True}"
                                   context="{'default_product_id': product_id}"/>
                            <field name="name" required="1" placeholder="Ingrese la referencia interna"/>
                            <field name="asset_category_id" readonly="1"/>
                            <field name="asset_class_id" readonly="1"/>
                        </group>
                    </sheet>
                </form>
            </field>
        </record>

        <record id="view_internal_reference_tree" model="ir.ui.view">
            <field name="name">internal.reference.tree</field>
            <field name="model">internal.reference</field>
            <field name="arch" type="xml">
                <list string="Referencias Internas">
                    <button name="action_clean_orphaned_references" 
                            type="object" 
                            string="Limpiar Referencias Huérfanas" 
                            class="btn-warning"
                            icon="fa-trash"
                            confirm="¿Está seguro de que desea eliminar las referencias internas huérfanas (sin producto válido)? Esta acción no se puede deshacer."/>
                    <field name="product_id"/>
                    <field name="name"/>
                    <field name="asset_category_id"/>
                    <field name="asset_class_id"/>
                </list>
            </field>
        </record>
        
        <!-- Acción para ver referencias internas -->
        <record id="action_internal_reference" model="ir.actions.act_window">
            <field name="name">Referencias Internas</field>
            <field name="res_model">internal.reference</field>
            <field name="view_mode">list,form</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No hay referencias internas
                </p>
                <p>
                    Las referencias internas están asociadas a un producto específico.
                    Puede crear nuevas referencias desde el wizard de actualización de inventario o desde los lotes.
                </p>
            </field>
        </record>
        
        <!-- Acción de servidor para limpiar referencias huérfanas -->
        <record id="action_clean_orphaned_references" model="ir.actions.server">
            <field name="name">Limpiar Referencias Internas Huérfanas</field>
            <field name="model_id" ref="model_internal_reference"/>
            <field name="binding_model_id" ref="model_internal_reference"/>
            <field name="binding_view_types">list</field>
            <field name="state">code</field>
            <field name="code">
action = env['internal.reference'].clean_all_orphaned_references()
            </field>
        </record>
        
        <!-- Acción de ventana para limpiar (alternativa con botón) -->
        <record id="action_clean_orphaned_references_window" model="ir.actions.act_window">
            <field name="name">Limpiar Referencias Huérfanas</field>
            <field name="res_model">internal.reference</field>
            <field name="view_mode">list</field>
            <field name="target">current</field>
            <field name="context">{}</field>
        </record>
    </data>
</odoo>

