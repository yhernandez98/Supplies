<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <record id="view_picking_form_inherit_supplies_columns" model="ir.ui.view">
    <field name="name">stock.picking.form.inherit.supplies.columns</field>
    <field name="model">stock.picking</field>
    <field name="inherit_id" ref="stock.view_picking_form"/>
    <field name="arch" type="xml">
      <xpath expr="//sheet" position="attributes">
        <attribute name="class" add="oe_stock_picking_sheet" separator=" "/>
      </xpath>
      <xpath expr="//header" position="attributes">
        <attribute name="class" add="oe_picking_header_pastel" separator=" "/>
      </xpath>
      <xpath expr="//header" position="inside">
        <button name="action_assign_supplies_relations" type="object" string="Asignar relaciones" class="btn-secondary" invisible="1"/>
      </xpath>

      <!-- Reemplazar con move_ids_main_only: Odoo 18 move_ids_without_package; Odoo 19 move_ids -->
      <xpath expr="//page[@name='operations']//field[@name='move_ids_without_package']" position="attributes">
        <attribute name="name">move_ids_main_only</attribute>
      </xpath>
      <xpath expr="//page[@name='operations']//field[@name='move_ids']" position="attributes">
        <attribute name="name">move_ids_main_only</attribute>
      </xpath>

      <xpath expr="//page[@name='operations']//field[@name='move_ids_main_only']//list/field[@name='product_id']" position="after">
        <!-- Campos ocultos que no queremos mostrar pero que pueden ser necesarios para el sistema -->
        <field name="supply_parent_product_id" string="Producto principal" readonly="1" column_invisible="1"/>
        <field name="supply_kind" string="Clasificación" readonly="1" column_invisible="1"/>
        
        <!-- Campos visibles -->
        <field name="principal_lot_serial" invisible="1" column_invisible="1"/>
        <field name="principal_lot_id" 
               string="Número de Serie"
               readonly="1" 
               optional="show"
               invisible="supply_kind != 'parent' or not principal_lot_id"
               options="{'no_open': True, 'no_create': True}"
               help="Número de serie del producto principal. Haga clic en el icono para editar."/>
        <button name="action_open_lot_wizard" 
                type="object" 
                string="✏️" 
                invisible="supply_kind != 'parent' or not principal_lot_id or picking_id.state == 'done'"
                class="oe_link"
                title="Haga clic para editar los elementos asociados del lote"
                attrs="{'invisible': [('supply_kind', '!=', 'parent'), ('principal_lot_id', '=', False), ('picking_id.state', '=', 'done')]}"/>

        <field name="associated_components" string="Componentes" readonly="1" optional="show" 
               invisible="supply_kind != 'parent'"
               widget="text"
               help="Componentes asociados al producto principal (Producto - Serial)"/>

        <field name="associated_peripherals" string="Periféricos" readonly="1" optional="show"
               invisible="supply_kind != 'parent'"
               widget="text"
               help="Periféricos asociados al producto principal (Producto - Serial)"/>

        <field name="associated_complements" string="Complementos" readonly="1" optional="show"
               invisible="supply_kind != 'parent'"
               widget="text"
               help="Complementos asociados al producto principal (Producto - Serial)"/>
      </xpath>
      
      <!-- Ocultar columna de embalaje (product_packaging_id) si existe en la vista -->
      <xpath expr="//page[@name='operations']//field[@name='move_ids_main_only']//list/field[@name='product_packaging_id']" position="attributes">
        <attribute name="column_invisible">1</attribute>
      </xpath>
      
      <!-- Ocultar cualquier campo relacionado con move_line_ids que pueda mostrar números de serie -->
      <xpath expr="//page[@name='operations']//field[@name='move_ids_main_only']//list/field[@name='move_line_ids']" position="attributes">
        <attribute name="column_invisible">1</attribute>
      </xpath>

    </field>
  </record>

  <!-- Actualizar Fecha Finalizacion Renting en devoluciones ya validadas -->
  <record id="action_backfill_renting_exit_dates" model="ir.actions.server">
    <field name="name">Actualizar Fecha Finalizacion Renting (devoluciones ya hechas)</field>
    <field name="model_id" ref="stock.model_stock_picking"/>
    <field name="state">code</field>
    <field name="code">result = env['stock.picking'].action_backfill_renting_exit_dates()</field>
  </record>
  <menuitem id="menu_action_backfill_renting_exit_dates"
            name="Actualizar F. Finalizacion Renting (devoluciones ya hechas)"
            parent="stock.menu_stock_config_settings"
            action="action_backfill_renting_exit_dates"
            sequence="50"/>

  <!-- Quitar F. Finalizacion Renting puesta por error en entregas -->
  <record id="action_clear_exit_date_from_deliveries" model="ir.actions.server">
    <field name="name">Quitar F. Finalizacion Renting (entregas procesadas por error)</field>
    <field name="model_id" ref="stock.model_stock_picking"/>
    <field name="state">code</field>
    <field name="code">result = env['stock.picking'].action_clear_exit_date_from_deliveries()</field>
  </record>
  <menuitem id="menu_action_clear_exit_date_from_deliveries"
            name="Quitar F. Finalizacion Renting (entregas por error)"
            parent="stock.menu_stock_config_settings"
            action="action_clear_exit_date_from_deliveries"
            sequence="51"/>
</odoo>
