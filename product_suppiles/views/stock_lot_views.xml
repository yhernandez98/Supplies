<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <!-- Vista principal: hereda de stock (no de stock_account) para que cargue aunque stock_account no exista o cambie -->
  <record id="view_production_lot_form_inherit_supplies" model="ir.ui.view">
    <field name="name">production.lot.form.supplies.inherit</field>
    <field name="model">stock.lot</field>
    <field name="inherit_id" ref="stock.view_production_lot_form"/>
    <field name="priority" eval="15"/>
    <field name="arch" type="xml">
      <!-- Clase para estilos pastel + reflejo (igual que suscripciones) -->
      <xpath expr="//form" position="attributes">
        <attribute name="class" add="o_stock_lot_pastel_form" separator=" "/>
      </xpath>
      <!-- Si existe company_currency_id (stock_account), hacerlo visible para alinear columnas -->
      <xpath expr="//field[@name='company_currency_id']" position="attributes">
        <attribute name="invisible">0</attribute>
      </xpath>
      <!-- Clases para alinear: Odoo 19 mantiene main_group; fallback por si cambia -->
      <xpath expr="//group[@name='main_group']/group[1]" position="attributes">
        <attribute name="class" add="o_stock_lot_left_col" separator=" "/>
      </xpath>
      <xpath expr="//group[@name='main_group']/group[2]" position="attributes">
        <attribute name="class" add="o_stock_lot_right_col" separator=" "/>
      </xpath>
      <xpath expr="//group[@name='inventory_group']" position="attributes">
        <attribute name="class" add="o_stock_lot_right_col" separator=" "/>
      </xpath>

      <!-- Cambiar etiqueta del campo name (solo Número de serie en header) -->
      <xpath expr="//sheet//field[@name='name'][not(ancestor::notebook)]" position="attributes">
        <attribute name="string">Número de serie</attribute>
        <attribute name="placeholder">Ingrese el número de serie</attribute>
      </xpath>
      
      <!-- Placa de Inventario, Placa de Seguridad, Hostname en formulario blanco (columna izquierda, antes de Producto) -->
      <xpath expr="//group[1]/group[1]/*[1]" position="before">
        <field name="inventory_plate" string="Placa de Inventario" placeholder="Ingrese la placa de inventario"/>
        <field name="security_plate" string="Placa de Seguridad" placeholder="Ingrese la placa de seguridad"/>
        <field name="hostname" string="Hostname" placeholder="Ingrese el hostname del equipo"/>
      </xpath>
      
      <!-- Mantener los otros campos en su ubicación original -->
      <xpath expr="//group[1]/group[1]" position="inside">
        <field name="model_name"/>
        <field name="billing_code"/>
      </xpath>
      <!-- Fechas para facturación prorrateada (solo productos/servicios, no aplica a licencias) -->
      <xpath expr="//field[@name='billing_code']" position="after">
        <field name="entry_date" string="Fecha Activacion Renting" help="Fecha en que el producto llegó al cliente (para cobro por días)"/>
        <field name="entry_date_display" string="Fecha activación (visible en suscripción)" invisible="1" help="Lo que se muestra en la suscripción: igual que arriba si hay fecha; si la borraste, aquí sigue la última guardada."/>
        <field name="exit_date" string="Fecha Finalizacion Renting" help="Fecha en que el producto salió del cliente (para cobro por días)"/>
        <field name="exit_date_display" string="Fecha finalización (visible en suscripción)" invisible="1" help="Lo que se muestra en la suscripción: igual que arriba si hay fecha; si la borraste, aquí sigue la última guardada hasta la limpieza."/>
      </xpath>
      
      <!-- Plazo Renting en columna derecha (acorta la lista izquierda) -->
      <xpath expr="//group[@name='main_group']/group[2]" position="inside">
        <field name="reining_plazo" string="Plazo Renting" help="Plazo en meses o fecha personalizada"/>
        <field name="reining_plazo_custom_months" string="Meses (personalizado)" invisible="reining_plazo != 'custom'" optional="show"/>
      </xpath>

      <!-- Odoo 19: vista base no tiene notebook; insertarlo después del último group del sheet (funciona con o sin group description) -->
      <xpath expr="//sheet/group[last()]" position="after">
        <notebook/>
      </xpath>
      <xpath expr="//sheet/notebook" position="inside">

        <!-- Pestaña Información: agrupa Información de Asociación, Elementos Asociados, etc. como subpestañas -->
        <page string="Información" name="info_group">
          <notebook>
            <!-- Sección que solo se muestra si este lote está asociado como elemento a otro producto principal -->
            <page string="Información de Asociación" name="associated_element_info" class="page-associated-info-red" invisible="not is_associated_element">
              <field name="is_associated_element" invisible="1"/>
              <group string="Este producto está asociado como elemento a otro producto principal">
                <div class="alert alert-info" role="alert" style="margin-bottom: 15px;">
                  <strong>ℹ️ Información:</strong> Este serial está asociado como 
                  <field name="associated_item_type" readonly="1"/>
                  a otro producto principal.
                </div>
                <group>
                  <field name="associated_to_principal_product_id" string="Producto Principal" readonly="1" options="{'no_open': False}"/>
                  <field name="associated_to_principal_lot_id" string="Serial Principal" readonly="1" options="{'no_open': False}"/>
                  <field name="associated_to_principal_inventory_plate" string="Placa de Inventario Principal" readonly="1"/>
                  <field name="associated_item_type" string="Tipo de Asociación" readonly="1"/>
                </group>
              </group>
            </page>

            <page string="Recepción / Enlace principal" name="supplies_link">
              <group>
                <field name="is_principal" readonly="1"/>
                <field name="principal_product_id" options="{'no_open': False}"/>
                <field name="principal_lot_id" options="{'no_open': False}"/>
                <field name="purchase_tracking_ref" readonly="1"/>
              </group>
            </page>

            <page string="Elementos Asociados" name="supplies_components">
          <notebook>
            <page string="Elementos Sin Costo" name="supplies_components_no_cost">
              <field name="lot_supply_line_sin_costo_ids" nolabel="1" context="{'default_has_cost': False}">
                <list editable="bottom">
                  <field name="lot_id" readonly="1" string="Serial padre"/>
                  <field name="has_cost" column_invisible="1"/>
                  <field name="item_type" string="Tipo" required="1"/>
                  <field name="available_product_ids" invisible="1" column_invisible="1"/>
                  <field name="product_id" domain="[('id', 'in', available_product_ids)]" options="{'no_create': True}"/>
                  <field name="quantity" invisible="1" column_invisible="1"/>
                  <field name="related_lot_id" required="1" string="Serial"/>
                  <field name="has_associated_items" column_invisible="1"/>
                  <field name="associated_items_summary" string="Tiene asociado" readonly="1"
                         widget="text"
                         decoration-info="has_associated_items == True"
                         help="Muestra los elementos asociados a este componente"/>
                  <field name="associated_items_serials" column_invisible="1"
                         invisible="1"
                         widget="many2many"
                         options="{'no_create': True, 'no_open': True}"/>
                  <field name="associated_items_serials_display" string="Serial" readonly="1"
                         widget="text"
                         decoration-info="has_associated_items == True"
                         help="Seriales de los elementos asociados"/>
                  <field name="uom_id" invisible="1" column_invisible="1"/>
                </list>
                <form>
                  <sheet>
                    <group>
                      <field name="has_cost" invisible="1"/>
                      <field name="item_type" string="Tipo" required="1"/>
                      <field name="available_product_ids" invisible="1"/>
                      <field name="product_id" domain="[('id', 'in', available_product_ids)]" options="{'no_create': True}"/>
                      <field name="quantity"/>
                      <field name="related_lot_id" required="1"/>
                      <field name="uom_id"/>
                    </group>
                  </sheet>
                </form>
              </field>
            </page>
            <page string="Elementos Con Costo" name="supplies_components_with_cost">
              <field name="lot_supply_line_con_costo_ids" nolabel="1" context="{'default_has_cost': True}">
                <list editable="bottom">
                  <field name="lot_id" readonly="1" string="Serial padre"/>
                  <field name="has_cost" column_invisible="1"/>
                  <field name="item_type" string="Tipo" required="1"/>
                  <field name="available_product_ids" invisible="1" column_invisible="1"/>
                  <field name="product_id" domain="[('id', 'in', available_product_ids)]" options="{'no_create': True}"/>
                  <field name="quantity" invisible="1" column_invisible="1"/>
                  <field name="related_lot_id" required="1" string="Serial"/>
                  <field name="cost" string="Costo"/>
                  <field name="has_associated_items" column_invisible="1"/>
                  <field name="associated_items_summary" string="Tiene asociado" readonly="1"
                         widget="text"
                         decoration-info="has_associated_items == True"
                         help="Muestra los elementos asociados a este componente"/>
                  <field name="associated_items_serials" column_invisible="1"
                         invisible="1"
                         widget="many2many"
                         options="{'no_create': True, 'no_open': True}"/>
                  <field name="associated_items_serials_display" string="Serial" readonly="1"
                         widget="text"
                         decoration-info="has_associated_items == True"
                         help="Seriales de los elementos asociados"/>
                  <field name="uom_id" invisible="1" column_invisible="1"/>
                </list>
                <form>
                  <sheet>
                    <group>
                      <field name="has_cost" invisible="1"/>
                      <field name="item_type" string="Tipo" required="1"/>
                      <field name="available_product_ids" invisible="1"/>
                      <field name="product_id" domain="[('id', 'in', available_product_ids)]" options="{'no_create': True}"/>
                      <field name="cost" string="Costo"/>
                      <field name="quantity"/>
                      <field name="related_lot_id" required="1"/>
                      <field name="uom_id"/>
                    </group>
                  </sheet>
                </form>
              </field>
            </page>
          </notebook>
        </page>
          </notebook>
        </page>
      </xpath>
    </field>
  </record>

  <!-- Heredar vista de lista para mostrar cantidad y agregar filtro -->
  <record id="view_production_lot_tree_inherit_supplies" model="ir.ui.view">
    <field name="name">production.lot.tree.supplies.inherit</field>
    <field name="model">stock.lot</field>
    <field name="inherit_id" ref="stock.view_production_lot_tree"/>
    <field name="priority" eval="15"/>
    <field name="arch" type="xml">
      <!-- Mostrar campo product_qty siempre visible -->
      <xpath expr="//field[@name='product_qty']" position="attributes">
        <attribute name="optional">show</attribute>
        <attribute name="string">Cantidad a la mano</attribute>
      </xpath>
      <!-- Agregar campo has_excess_quantity después de product_qty -->
      <xpath expr="//field[@name='product_qty']" position="after">
        <field name="has_excess_quantity" optional="hide" string="⚠️ Cantidad > 1"/>
      </xpath>
      <!-- Código Facturación: no visible por defecto, pero se puede activar desde el menú de columnas -->
      <xpath expr="//list" position="inside">
        <field name="billing_code" string="Código Facturación" optional="hide"/>
      </xpath>
      <!-- Agregar decoración visual para seriales con cantidad > 1 -->
      <xpath expr="//list" position="attributes">
        <attribute name="decoration-danger">has_excess_quantity == True</attribute>
      </xpath>
    </field>
  </record>

  <!-- Vista de búsqueda para agregar filtro de cantidad -->
  <record id="view_production_lot_search_inherit_supplies" model="ir.ui.view">
    <field name="name">production.lot.search.supplies.inherit</field>
    <field name="model">stock.lot</field>
    <field name="type">search</field>
    <field name="priority" eval="15"/>
    <field name="arch" type="xml">
      <search string="Buscar Seriales">
        <field name="name" string="Número de Serie"/>
        <field name="product_id" string="Producto"/>
        <field name="has_excess_quantity" invisible="1"/>
        <separator/>
        <filter string="⚠️ Cantidad > 1 (Error)" name="excess_quantity" domain="[('has_excess_quantity', '=', True)]" help="Seriales con cantidad a la mano mayor a 1"/>
        <filter string="✓ Cantidad Correcta" name="correct_quantity" domain="[('has_excess_quantity', '!=', True)]" help="Seriales con cantidad a la mano = 1"/>
      </search>
    </field>
  </record>

</odoo>
