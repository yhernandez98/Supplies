<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Vista de lista para mantenimientos -->
        <record id="view_lot_maintenance_tree" model="ir.ui.view">
            <field name="name">stock.lot.maintenance.list</field>
            <field name="model">stock.lot.maintenance</field>
            <field name="type">list</field>
            <field name="arch" type="xml">
                <list string="Mantenimientos" decoration-muted="status == 'cancelled'" decoration-success="status == 'completed'" decoration-info="status == 'draft'">
                    <field name="maintenance_order_id" string="Orden"/>
                    <field name="lot_id" string="N√∫mero de Serie"/>
                    <field name="inventory_plate" string="Placa Inventario" optional="hide"/>
                    <field name="maintenance_date" string="Fecha"/>
                    <field name="maintenance_type" string="Tipo"/>
                    <field name="technician_id" string="T√©cnico"/>
                    <field name="description" string="Descripci√≥n"/>
                    <field name="currency_id" invisible="1"/>
                    <field name="cost" string="Costo" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                    <field name="status" string="Estado"/>
                    <field name="is_signed" invisible="1"/>
                    <field name="next_maintenance_date" string="Pr√≥ximo Mantenimiento"/>
                </list>
            </field>
        </record>

        <!-- Vista de formulario para mantenimientos -->
        <record id="view_lot_maintenance_form" model="ir.ui.view">
            <field name="name">stock.lot.maintenance.form</field>
            <field name="model">stock.lot.maintenance</field>
            <field name="arch" type="xml">
                <form string="Mantenimiento">
                    <header>
                        <button name="action_create_ticket" string="Crear Ticket" type="object" class="btn-secondary" invisible="is_signed or ticket_id"/>
                        <button name="action_view_helpdesk_ticket" string="Ver Ticket" type="object" class="btn-secondary" invisible="not ticket_id"/>
                        <button name="action_convert_to_repair" string="üîß Crear Reparaci√≥n" type="object" class="btn-primary" icon="fa-wrench" invisible="repair_order_id"/>
                        <button name="action_view_repair_order" string="Ver Reparaci√≥n" type="object" class="btn-secondary" invisible="not repair_order_id"/>
                        <button name="action_equipment_change" string="üîÑ Cambio de Equipo" type="object" class="btn-secondary" icon="fa-exchange"/>
                        <button name="action_request_element" string="üì¶ Solicitar Elemento" type="object" class="btn-secondary" icon="fa-shopping-cart"/>
                        <button name="action_generate_pdf_report" string="Generar PDF" type="object" class="btn-primary" icon="fa-file-pdf"/>
                    </header>
                    <sheet>
                        <!-- Campos para evaluaci√≥n de condiciones -->
                        <field name="is_signed" invisible="1"/>
                        <field name="status" invisible="1"/>
                        <field name="show_warning_alert" invisible="1"/>
                        <field name="show_info_alert" invisible="1"/>
                        
                        <!-- Alertas de estado -->
                        <group invisible="not show_warning_alert">
                            <div class="alert alert-warning" role="alert" style="margin-bottom: 15px; padding: 10px 15px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
                                <strong>‚ö†Ô∏è Advertencia:</strong> Este mantenimiento est√° firmado y no puede ser modificado.
                            </div>
                        </group>
                        <group invisible="not show_info_alert">
                            <div class="alert alert-info" role="alert" style="margin-bottom: 15px; padding: 10px 15px; background-color: #d1ecf1; border: 1px solid #0c5460; border-radius: 4px;">
                                <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Este mantenimiento est√° en borrador. Debe contar con las firmas del t√©cnico y del cliente antes de cambiar el estado.
                            </div>
                        </group>
                        <group>
                            <group>
                                <field name="maintenance_order_id" options="{'no_create': True}" readonly="is_signed"/>
                                <field name="lot_id" options="{'no_open': True}" readonly="is_signed" required="1"/>
                                <field name="inventory_plate" readonly="1"/>
                                <field name="product_id" readonly="1"/>
                                <field name="customer_id" readonly="1"/>
                                <field name="ticket_id" options="{'no_create': True}" readonly="1"/>
                                <field name="repair_order_id" options="{'no_create': True}" readonly="1"/>
                            </group>
                            <group>
                                <field name="maintenance_date" required="1" readonly="is_signed"/>
                                <field name="maintenance_type" required="1" readonly="is_signed"/>
                                <field name="technician_id" required="1" readonly="is_signed"/>
                                <field name="technician_ids" widget="many2many_tags" readonly="is_signed"/>
                                <field name="status" invisible="1"/>
                            </group>
                        </group>
                        <group>
                            <group>
                                <field name="currency_id" invisible="1"/>
                                <field name="cost" widget="monetary" options="{'currency_field': 'currency_id'}" readonly="is_signed"/>
                                <field name="duration" readonly="is_signed"/>
                                <field name="next_maintenance_date" readonly="is_signed"/>
                            </group>
                        </group>
                        <notebook>
                            <page string="üìù Reporte del Trabajo" name="description">
                                <div class="alert alert-success" role="alert" style="margin-bottom: 15px; padding: 15px; background-color: #d4edda; border: 1px solid #28a745; border-radius: 4px;">
                                    <strong>üìù Editor enriquecido tipo Word:</strong> Puedes formatear el texto (negrita, cursiva, listas, etc.), agregar im√°genes directamente desde el editor, crear tablas y mucho m√°s. Las im√°genes se pueden arrastrar y soltar o pegar desde el portapapeles.
                                </div>
                                <group>
                                    <field name="description" widget="html" placeholder="Describa detalladamente el trabajo realizado... Puede incluir formato, im√°genes, tablas, etc." readonly="is_signed" nolabel="1" 
                                           options="{'toolbar': 'full', 'resizable': true, 'height': 400}"/>
                                </group>
                                <div class="alert alert-info" role="alert" style="margin-top: 15px; padding: 10px 15px; background-color: #d1ecf1; border: 1px solid #0c5460; border-radius: 4px;">
                                    <strong>üí° Tip:</strong> Puedes arrastrar y soltar im√°genes directamente en el editor, o usar el bot√≥n de imagen en la barra de herramientas para insertar im√°genes.
                                </div>
                            </page>
                            <page string="üí° Observaciones" name="observations">
                                <div class="alert alert-info" role="alert" style="margin-bottom: 15px;">
                                    <strong>üí° Observaciones:</strong> Puedes agregar observaciones con formato enriquecido e im√°genes.
                                </div>
                                <field name="observations" widget="html" placeholder="Observaciones, hallazgos, recomendaciones..." readonly="is_signed" nolabel="1"
                                       options="{'toolbar': 'full', 'resizable': true, 'height': 300}"/>
                            </page>
                            <page string="üîß Cambios de Componentes" name="components">
                                <div class="alert alert-info" role="alert" style="margin-bottom: 15px; padding: 10px 15px; background-color: #d1ecf1; border: 1px solid #0c5460; border-radius: 4px;">
                                    <strong>üîß Cambios de Componentes:</strong> Registra los componentes retirados e instalados durante este mantenimiento. Los cambios se reflejar√°n autom√°ticamente en la pesta√±a "Elementos asociados" del inventario.
                                </div>
                                <field name="component_change_ids" nolabel="1">
                                    <list>
                                        <field name="change_date"/>
                                        <field name="product_id"/>
                                        <field name="old_component_lot_id"/>
                                        <field name="new_component_lot_id"/>
                                        <field name="reason"/>
                                    </list>
                                    <form>
                                        <group>
                                            <group>
                                                <field name="change_date"/>
                                                <field name="product_id" required="1"/>
                                            </group>
                                            <group>
                                                <field name="old_component_lot_id"/>
                                                <field name="new_component_lot_id"/>
                                            </group>
                                        </group>
                                        <group>
                                            <field name="reason" placeholder="Motivo del cambio..."/>
                                        </group>
                                    </form>
                                </field>
                            </page>
                            <page string="Firmas" name="signatures">
                                <div class="alert alert-info" role="alert" style="margin-bottom: 15px;">
                                    <strong>Informaci√≥n:</strong> Las firmas ya no son obligatorias. Si la orden de mantenimiento tiene firmas, estas se aplicar√°n autom√°ticamente a este mantenimiento.
                                </div>
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <button name="action_generate_pdf_report" type="object" 
                                            string="Generar Reporte PDF" 
                                            class="btn-primary"
                                            icon="fa-file-pdf"
                                            help="Generar un reporte PDF de este mantenimiento para entregar al cliente"/>
                                </div>
                                <group>
                                    <group string="Firma del T√©cnico">
                                        <field name="technician_signature" widget="signature" options="{'signature_type': 'standard', 'height': 100, 'width': 300}" readonly="is_signed"/>
                                        <field name="technician_signed_by" readonly="1"/>
                                        <field name="technician_signed_date" readonly="1"/>
                                    </group>
                                    <group string="Firma del Cliente">
                                        <field name="customer_signature" widget="signature" options="{'signature_type': 'standard', 'height': 100, 'width': 300}" readonly="is_signed"/>
                                        <field name="customer_signed_by" readonly="1"/>
                                        <field name="customer_signed_date" readonly="1"/>
                                    </group>
                                </group>
                                <group invisible="not is_signed">
                                    <div class="alert alert-success" role="alert" style="margin-top: 15px; padding: 10px 15px; background-color: #d4edda; border: 1px solid #28a745; border-radius: 4px;">
                                        <strong>‚úì Mantenimiento Firmado:</strong> Este mantenimiento cuenta con ambas firmas y est√° completo.
                                    </div>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                    <chatter/>
                </form>
            </field>
        </record>

        <!-- Vista de b√∫squeda para mantenimientos -->
        <record id="view_lot_maintenance_search" model="ir.ui.view">
            <field name="name">stock.lot.maintenance.search</field>
            <field name="model">stock.lot.maintenance</field>
            <field name="arch" type="xml">
                <search>
                    <field name="lot_id" string="N√∫mero de Serie/Placa"/>
                    <field name="inventory_plate" string="Placa de Inventario"/>
                    <field name="product_id" string="Producto"/>
                    <field name="customer_id" string="Cliente"/>
                    <field name="technician_id" string="T√©cnico"/>
                    <field name="maintenance_type" string="Tipo"/>
                    <separator/>
                    <filter string="Borrador" name="draft" domain="[('status', '=', 'draft')]"/>
                    <filter string="Completados" name="completed" domain="[('status', '=', 'completed')]"/>
                    <filter string="Pendientes" name="pending" domain="[('status', '=', 'pending')]"/>
                    <filter string="Firmados" name="signed" domain="[('is_signed', '=', True)]"/>
                    <filter string="Este Mes" name="this_month" domain="[('maintenance_date', '>=', (context_today() - relativedelta(months=1)).strftime('%Y-%m-01'))]"/>
                    <separator string="Agrupar por"/>
                    <group>
                        <filter string="Tipo" name="group_type" context="{'group_by': 'maintenance_type'}"/>
                        <filter string="T√©cnico" name="group_technician" context="{'group_by': 'technician_id'}"/>
                        <filter string="Estado" name="group_status" context="{'group_by': 'status'}"/>
                        <filter string="Mes" name="group_month" context="{'group_by': 'maintenance_date:month'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Acci√≥n para abrir mantenimientos -->
        <record id="action_lot_maintenance" model="ir.actions.act_window">
            <field name="name">Mantenimientos de Productos</field>
            <field name="res_model">stock.lot.maintenance</field>
            <field name="view_mode">list,form</field>
            <field name="search_view_id" ref="view_lot_maintenance_search"/>
            <field name="context">{'default_technician_id': uid}</field>
        </record>
    </data>
</odoo>

