<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Vista Lista de Ordenes de Mantenimiento - Dise帽o Profesional -->
        <record id="view_maintenance_order_list" model="ir.ui.view">
            <field name="name">maintenance.order.list</field>
            <field name="model">maintenance.order</field>
            <field name="arch" type="xml">
                <list string="rdenes de Servicio">
                    <field name="name" string="N煤mero de Orden"/>
                    <field name="activity_type" widget="badge" 
                           decoration-info="activity_type == 'visit'"
                           decoration-success="activity_type == 'maintenance'"
                           decoration-warning="activity_type == 'inspection'"
                           decoration-danger="activity_type == 'repair'"
                           decoration-muted="activity_type == 'installation'"
                           string="Tipo"/>
                    <field name="partner_id" string="Cliente"/>
                    <field name="technician_ids" widget="many2many_tags" options="{'no_create': True}" string="T茅cnicos"/>
                    <field name="scheduled_date" string="Fecha Programada" widget="date"/>
                    <field name="state" widget="badge" 
                           decoration-success="state == 'completed'" 
                           decoration-info="state == 'in_progress'" 
                           decoration-warning="state == 'scheduled'" 
                           decoration-muted="state == 'cancelled'"
                           decoration-danger="state == 'draft'"
                           string="Estado"/>
                    <field name="maintenance_count" string="Total" optional="hide"/>
                    <field name="completed_maintenance_count" string="Completados" optional="hide"/>
                </list>
            </field>
        </record>

        <!-- Vista Formulario de Orden de Mantenimiento -->
        <record id="view_maintenance_order_form" model="ir.ui.view">
            <field name="name">maintenance.order.form</field>
            <field name="model">maintenance.order</field>
            <field name="arch" type="xml">
                <form string="Orden de Mantenimiento">
                    <header>
                        <button name="action_confirm" string="Programar" type="object" class="oe_highlight" invisible="state != 'draft'"/>
                        <button name="action_start" string="Iniciar" type="object" class="oe_highlight" invisible="state != 'scheduled'"/>
                        <button name="action_complete" string="Completar" type="object" class="oe_highlight" invisible="state != 'in_progress'"/>
                        <button name="action_cancel" string="Cancelar" type="object" invisible="state in ('completed', 'cancelled')"/>
                        <button name="action_add_equipment" string="Agregar Equipos" type="object" class="btn-secondary" invisible="state in ('completed', 'cancelled')"/>
                        <button name="action_generate_pdf_report" string="Generar Reporte" type="object" class="btn-primary" icon="fa-file-pdf" invisible="state != 'completed' or not maintenance_ids"/>
                        <field name="state" widget="statusbar" statusbar_visible="draft,scheduled,in_progress,completed"/>
                    </header>
                    <sheet>
                        <!-- Campo oculto para evaluar condiciones -->
                        <field name="is_signed" invisible="1"/>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_view_maintenances" type="object" class="oe_stat_button" icon="fa-wrench">
                                <field name="maintenance_count" widget="statinfo" string="Mantenimientos"/>
                            </button>
                            <button name="action_view_maintenances" type="object" class="oe_stat_button" icon="fa-check-circle" invisible="completed_maintenance_count == 0">
                                <field name="completed_maintenance_count" widget="statinfo" string="Completados"/>
                            </button>
                            <button name="action_view_ticket" type="object" class="oe_stat_button" icon="fa-ticket" invisible="not ticket_id">
                                <field name="ticket_id" widget="statinfo" string="Ticket"/>
                            </button>
                        </div>
                        <group>
                            <group>
                                <field name="name"/>
                                <field name="activity_type" widget="radio" options="{'horizontal': true}"/>
                                <field name="partner_id" options="{'no_create': True}"/>
                                <field name="technician_ids" widget="many2many_tags" options="{'no_create': True}"/>
                                <field name="ticket_id" options="{'no_create': True, 'no_open': True}" readonly="1"/>
                            </group>
                            <group>
                                <field name="scheduled_date"/>
                                <field name="deadline_date"/>
                                <field name="maintenance_count" readonly="1"/>
                                <field name="completed_maintenance_count" readonly="1"/>
                                <button name="action_view_calendar" string="Ver en Calendario" type="object" 
                                        class="btn-secondary" icon="fa-calendar" 
                                        invisible="not calendar_event_ids or state in ('cancelled', 'completed')"/>
                            </group>
                        </group>
                        <group invisible="activity_type != 'visit'">
                            <field name="visit_purpose" placeholder="Descripci贸n del objetivo de la visita..."/>
                        </group>
                        <notebook>
                            <page string="Mantenimientos" name="maintenances">
                                <field name="maintenance_ids" nolabel="1" context="{'default_maintenance_order_id': id}">
                                    <list>
                                        <field name="lot_id"/>
                                        <field name="inventory_plate" string="Placa Inventario" optional="hide"/>
                                        <field name="product_id"/>
                                        <field name="maintenance_type"/>
                                        <field name="maintenance_date"/>
                                        <field name="status" widget="badge" decoration-success="status == 'completed'" decoration-info="status == 'in_progress'" decoration-warning="status == 'scheduled'"/>
                                        <field name="technician_id"/>
                                    </list>
                                    <form>
                                        <header>
                                            <button name="action_convert_to_repair" string=" Crear Reparaci贸n" type="object" class="btn-primary" icon="fa-wrench" invisible="repair_order_id"/>
                                            <button name="action_view_repair_order" string="Ver Reparaci贸n" type="object" class="btn-secondary" invisible="not repair_order_id"/>
                                            <button name="action_equipment_change" string=" Cambio de Equipo" type="object" class="btn-secondary" icon="fa-exchange"/>
                                            <button name="action_request_element" string=" Solicitar Elemento" type="object" class="btn-secondary" icon="fa-shopping-cart"/>
                                        </header>
                                        <sheet>
                                            <group>
                                                <group>
                                                    <field name="lot_id" required="1"/>
                                                    <field name="inventory_plate" readonly="1"/>
                                                    <field name="maintenance_type" required="1"/>
                                                    <field name="maintenance_date" required="1"/>
                                                </group>
                                                <group>
                                                    <field name="technician_id"/>
                                                    <field name="status"/>
                                                    <field name="repair_order_id" invisible="1"/>
                                                </group>
                                            </group>
                                            <group>
                                                <field name="technician_ids" widget="many2many_tags" string="Todos los T茅cnicos Asignados"/>
                                            </group>
                                            <notebook>
                                                <page string=" Descripci贸n del Trabajo" name="description">
                                                    <div class="alert alert-info" role="alert" style="margin-bottom: 10px; padding: 10px; background-color: #d1ecf1; border: 1px solid #0c5460; border-radius: 4px; font-size: 12px;">
                                                        <strong> Editor enriquecido:</strong> Puedes usar formato de texto, agregar im谩genes y crear un documento detallado.
                                                    </div>
                                                    <field name="description" widget="html" nolabel="1" 
                                                           options="{'toolbar': 'full', 'resizable': true, 'height': 350}"/>
                                                </page>
                                                <page string=" Cambios de Componentes" name="components">
                                                    <field name="component_change_ids" nolabel="1">
                                                        <list>
                                                            <field name="change_date"/>
                                                            <field name="product_id"/>
                                                            <field name="old_component_lot_id"/>
                                                            <field name="new_component_lot_id"/>
                                                            <field name="reason"/>
                                                        </list>
                                                        <form>
                                                            <group>
                                                                <group>
                                                                    <field name="change_date"/>
                                                                    <field name="product_id" required="1"/>
                                                                </group>
                                                                <group>
                                                                    <field name="old_component_lot_id"/>
                                                                    <field name="new_component_lot_id"/>
                                                                </group>
                                                            </group>
                                                            <group>
                                                                <field name="reason" placeholder="Motivo del cambio..."/>
                                                            </group>
                                                        </form>
                                                    </field>
                                                </page>
                                            </notebook>
                                        </sheet>
                                    </form>
                                </field>
                            </page>
                            <page string="Descripci贸n" name="description">
                                <field name="description" nolabel="1" placeholder="Descripci贸n general de la orden de mantenimiento..."/>
                            </page>
                            <page string="Notas" name="notes">
                                <field name="notes" nolabel="1" placeholder="Notas adicionales..."/>
                            </page>
                            <page string="Calendario" name="calendar" invisible="not calendar_event_ids">
                                <div class="alert alert-info" role="alert" style="margin-bottom: 15px;">
                                    <strong> Eventos de Calendario:</strong> Los eventos se crean autom谩ticamente cuando se programa la orden.
                                </div>
                                <field name="calendar_event_ids" nolabel="1" readonly="1">
                                    <list>
                                        <field name="name"/>
                                        <field name="start"/>
                                        <field name="stop"/>
                                        <field name="user_id"/>
                                    </list>
                                </field>
                            </page>
                            <page string="Firmas" name="signatures">
                                <div class="alert alert-info" role="alert" style="margin-bottom: 15px;">
                                    <strong> Firmas M煤ltiples:</strong> Todos los t茅cnicos asignados deben firmar esta orden. Las firmas se aplicar谩n autom谩ticamente a todos los mantenimientos relacionados.
                                </div>
                                
                                <!-- Firmas de T茅cnicos -->
                                <div style="margin-bottom: 30px;">
                                    <h3 style="color: #495057; margin-bottom: 15px; border-bottom: 2px solid #4a90e2; padding-bottom: 8px;">
                                        Firmas de T茅cnicos
                                    </h3>
                                    <field name="technician_signature_ids" nolabel="1">
                                        <list editable="bottom" style="width: 100%;">
                                            <field name="technician_id" readonly="1"/>
                                            <field name="signature" widget="signature" options="{'signature_type': 'standard', 'height': 100, 'width': 300}" force_save="1"/>
                                            <field name="signature_date" readonly="1"/>
                                        </list>
                                        <form>
                                            <sheet>
                                                <group>
                                                    <group>
                                                        <field name="technician_id" readonly="1"/>
                                                        <field name="signature" widget="signature" options="{'signature_type': 'standard', 'height': 100, 'width': 300}"/>
                                                    </group>
                                                    <group>
                                                        <field name="signature_date" readonly="1"/>
                                                    </group>
                                                </group>
                                            </sheet>
                                        </form>
                                    </field>
                                </div>
                                
                                <!-- Firma del Cliente -->
                                <div style="border-top: 2px solid #dee2e6; padding-top: 20px;">
                                    <h3 style="color: #495057; margin-bottom: 15px; border-bottom: 2px solid #28a745; padding-bottom: 8px;">
                                        Firma del Cliente
                                    </h3>
                                    <div style="text-align: center; padding: 10px;">
                                        <field name="customer_signature" widget="signature" options="{'signature_type': 'standard', 'height': 100, 'width': 300}" readonly="is_signed"/>
                                        <field name="customer_signed_by" readonly="1"/>
                                        <field name="customer_signed_date" readonly="1"/>
                                    </div>
                                </div>
                                
                                <!-- Bot贸n para aplicar firmas -->
                                <div style="text-align: center; margin-top: 20px;">
                                    <button name="action_apply_signatures_to_maintenances" 
                                            type="object" 
                                            string="Aplicar Firmas a Todos los Mantenimientos" 
                                            class="btn-primary"
                                            invisible="not is_signed or not maintenance_ids"
                                            help="Aplicar las firmas de esta orden a todos los mantenimientos relacionados"/>
                                </div>
                            </page>
                        </notebook>
                    </sheet>
                    <chatter/>
                </form>
            </field>
        </record>

        <!-- Vista Kanban de Ordenes de Mantenimiento - Dise帽o Profesional -->
        <record id="view_maintenance_order_kanban" model="ir.ui.view">
            <field name="name">maintenance.order.kanban</field>
            <field name="model">maintenance.order</field>
            <field name="arch" type="xml">
                <kanban default_group_by="state" class="o_kanban_mobile maintenance_order_kanban">
                    <field name="name"/>
                    <field name="partner_id"/>
                    <field name="activity_type"/>
                    <field name="technician_ids"/>
                    <field name="scheduled_date"/>
                    <field name="state"/>
                    <field name="maintenance_count"/>
                    <field name="completed_maintenance_count"/>
                    <field name="ticket_id"/>
                    <templates>
                        <t t-name="card">
                            <div class="oe_kanban_card oe_kanban_global_click" 
                                 t-attf-class="maintenance_order_card maintenance_order_card_#{record.state.raw_value}">
                                <!-- Header con n煤mero de orden y badge de estado -->
                                <div class="maintenance_card_header">
                                    <div class="maintenance_card_title">
                                        <strong class="maintenance_order_number"><field name="name"/></strong>
                                        <span class="maintenance_state_badge" t-attf-class="maintenance_state_badge maintenance_state_badge_#{record.state.raw_value}">
                                            <field name="state" widget="badge"/>
                                        </span>
                                    </div>
                                    <div class="maintenance_activity_type" t-attf-class="maintenance_activity_type maintenance_activity_type_#{record.activity_type.raw_value}">
                                        <t t-if="record.activity_type.raw_value == 'visit'">
                                            <i class="fa fa-calendar-check-o"/> Visita
                                        </t>
                                        <t t-if="record.activity_type.raw_value == 'maintenance'">
                                            <i class="fa fa-wrench"/> Mantenimiento
                                        </t>
                                        <t t-if="record.activity_type.raw_value == 'inspection'">
                                            <i class="fa fa-search"/> Inspecci贸n
                                        </t>
                                        <t t-if="record.activity_type.raw_value == 'repair'">
                                            <i class="fa fa-tools"/> Reparaci贸n
                                        </t>
                                        <t t-if="record.activity_type.raw_value == 'installation'">
                                            <i class="fa fa-cog"/> Instalaci贸n
                                        </t>
                                    </div>
                                </div>
                                
                                <!-- Informaci贸n del Cliente -->
                                <div class="maintenance_card_section">
                                    <div class="maintenance_section_label">
                                        <i class="fa fa-building"/> Cliente
                                    </div>
                                    <div class="maintenance_section_value">
                                        <field name="partner_id"/>
                                    </div>
                                </div>
                                
                                <!-- T茅cnicos Asignados -->
                                <div class="maintenance_card_section">
                                    <div class="maintenance_section_label">
                                        <i class="fa fa-users"/> T茅cnicos
                                    </div>
                                    <div class="maintenance_section_value">
                                        <field name="technician_ids" widget="many2many_tags" options="{'color_field': 'color', 'no_create': True}"/>
                                    </div>
                                </div>
                                
                                <!-- Fecha Programada -->
                                <div class="maintenance_card_section">
                                    <div class="maintenance_section_label">
                                        <i class="fa fa-calendar"/> Fecha Programada
                                    </div>
                                    <div class="maintenance_section_value">
                                        <field name="scheduled_date"/>
                                    </div>
                                </div>
                                
                                <!-- Progreso de Mantenimientos -->
                                <div class="maintenance_card_section maintenance_progress_section">
                                    <div class="maintenance_progress_header">
                                        <span class="maintenance_section_label">
                                            <i class="fa fa-tasks"/> Mantenimientos
                                        </span>
                                        <span class="maintenance_progress_text">
                                            <field name="completed_maintenance_count"/> / <field name="maintenance_count"/>
                                        </span>
                                    </div>
                                    <div class="maintenance_progress_bar_container">
                                        <t t-set="progress_percent" t-value="record.maintenance_count.raw_value > 0 ? (record.completed_maintenance_count.raw_value / record.maintenance_count.raw_value * 100) : 0"/>
                                        <div class="maintenance_progress_bar" t-attf-style="width: #{progress_percent}%">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Footer con informaci贸n adicional -->
                                <div class="maintenance_card_footer">
                                    <t t-if="record.ticket_id.raw_value">
                                        <span class="maintenance_footer_item">
                                            <i class="fa fa-ticket"/> Ticket vinculado
                                        </span>
                                    </t>
                                </div>
                            </div>
                        </t>
                    </templates>
                    <progressbar field="state" colors='{"draft": "warning", "scheduled": "info", "in_progress": "primary", "completed": "success", "cancelled": "muted"}'/>
                </kanban>
            </field>
        </record>

        <!-- Vista B煤squeda de Ordenes de Mantenimiento (sin group_by: evita Invalid view en Odoo 19) -->
        <record id="view_maintenance_order_search" model="ir.ui.view">
            <field name="name">maintenance.order.search</field>
            <field name="model">maintenance.order</field>
            <field name="type">search</field>
            <field name="arch" type="xml">
                <search string="Ordenes de Mantenimiento">
                    <field name="name"/>
                    <field name="partner_id"/>
                    <field name="activity_type"/>
                    <field name="technician_ids"/>
                    <field name="scheduled_date"/>
                    <separator/>
                    <filter string="Mantenimientos" name="maintenance" domain="[('activity_type', '=', 'maintenance')]"/>
                    <filter string="Visitas Programadas" name="visit" domain="[('activity_type', '=', 'visit')]"/>
                    <filter string="Inspecciones" name="inspection" domain="[('activity_type', '=', 'inspection')]"/>
                    <filter string="Reparaciones" name="repair" domain="[('activity_type', '=', 'repair')]"/>
                    <filter string="Instalaciones" name="installation" domain="[('activity_type', '=', 'installation')]"/>
                    <separator/>
                    <filter string="Borrador" name="draft" domain="[('state', '=', 'draft')]"/>
                    <filter string="Programada" name="scheduled" domain="[('state', '=', 'scheduled')]"/>
                    <filter string="En Progreso" name="in_progress" domain="[('state', '=', 'in_progress')]"/>
                    <filter string="Completada" name="completed" domain="[('state', '=', 'completed')]"/>
                    <filter string="Cancelada" name="cancelled" domain="[('state', '=', 'cancelled')]"/>
                </search>
            </field>
        </record>

        <!-- Acci贸n para Ordenes de Mantenimiento -->
        <record id="action_maintenance_order" model="ir.actions.act_window">
            <field name="name">rdenes de Servicio</field>
            <field name="res_model">maintenance.order</field>
            <field name="view_mode">kanban,list,form</field>
            <field name="search_view_id" ref="view_maintenance_order_search"/>
            <field name="context">{'search_default_group_state': 1, 'default_activity_type': 'maintenance'}</field>
            <field name="domain">[]</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Crear nueva orden de servicio
                </p>
                <p>
                    Las 贸rdenes de servicio permiten programar mantenimientos, visitas, inspecciones y otras actividades
                    para un mismo cliente y t茅cnico. Los tickets se crean autom谩ticamente.
                </p>
            </field>
        </record>
    </data>
</odoo>

