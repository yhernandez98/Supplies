<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Vista lista: equipos con renting por vencer (agrupable por cliente) -->
        <record id="view_stock_lot_tree_alertas_renting" model="ir.ui.view">
            <field name="name">stock.lot.tree.alertas.renting</field>
            <field name="model">stock.lot</field>
            <field name="arch" type="xml">
                <list string="Equipos a terminar Renting"
                      create="0"
                      delete="0"
                      default_order="exit_date asc, customer_id, name">
                    <field name="customer_id" string="Cliente"/>
                    <field name="product_id" string="Producto"/>
                    <field name="name" string="Número de serie/lote"/>
                    <field name="inventory_plate" string="Placa de Inventario"/>
                    <field name="entry_date" string="Fecha Activación"/>
                    <field name="exit_date" string="Fecha Finalización"/>
                    <field name="reining_plazo" string="Plazo Renting" optional="show"/>
                </list>
            </field>
        </record>

        <!-- Acción de ventana almacenada con view_ids explícitos (evita "View types not defined") -->
        <record id="action_alertas_renting_por_vencer_window" model="ir.actions.act_window">
            <field name="name">Equipos a terminar Renting</field>
            <field name="res_model">stock.lot</field>
            <field name="view_mode">list,form</field>
            <field name="view_id" ref="view_stock_lot_tree_alertas_renting"/>
            <field name="view_ids" eval="[(5, 0, 0),
                (0, 0, {'view_mode': 'list', 'view_id': ref('view_stock_lot_tree_alertas_renting')}),
                (0, 0, {'view_mode': 'form', 'view_id': ref('product_suppiles.view_production_lot_form_inherit_supplies')})]"/>
            <field name="search_view_id" ref="view_customer_inventory_lot_search"/>
            <field name="domain">[]</field>
            <field name="context">{'search_default_group_customer': 1, 'group_by': 'customer_id'}</field>
        </record>

        <!-- Acción de servidor: dominio dinámico (próximos 30 días) y devuelve acción SIN id para que el cliente use nuestro dict con views -->
        <record id="action_alertas_renting_por_vencer" model="ir.actions.server">
            <field name="name">Equipos a terminar Renting</field>
            <field name="model_id" ref="stock.model_stock_lot"/>
            <field name="state">code</field>
            <field name="code"><![CDATA[
env.cr.execute("SELECT CURRENT_DATE")
today = env.cr.fetchone()[0]
env.cr.execute("SELECT CURRENT_DATE + INTERVAL '30 days'")
end = env.cr.fetchone()[0]
tree_view = env.ref('mesa_ayuda_inventario.view_stock_lot_tree_alertas_renting')
form_view = env.ref('product_suppiles.view_production_lot_form_inherit_supplies', raise_if_not_found=False) or env.ref('stock.view_production_lot_form')
search_view = env.ref('mesa_ayuda_inventario.view_customer_inventory_lot_search')
action = {
    'type': 'ir.actions.act_window',
    'name': 'Equipos a terminar Renting',
    'res_model': 'stock.lot',
    'view_mode': 'list,form',
    'views': [(tree_view.id, 'list'), (form_view.id, 'form')],
    'search_view_id': search_view.id,
    'domain': [
        ('exit_date', '!=', False),
        ('exit_date', '>=', today),
        ('exit_date', '<=', end),
    ],
    'context': {'search_default_group_customer': 1, 'group_by': 'customer_id'},
}
]]></field>
        </record>
    </data>
</odoo>
